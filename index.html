<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Document Detective | Vertex AI & Firebase</title>
    
    <!-- PDF.js for PDF Parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Marked for Markdown Rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-dark: #0a0a0a;
            --bg-panel: #111111;
            --primary: #00d4ff; /* Cyan */
            --primary-dim: rgba(0, 212, 255, 0.1);
            --text-main: #e0e0e0;
            --text-muted: #888888;
            --border: #333333;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.05);
            --success: #00ff9d;
            --warning: #ffb800;
            --danger: #ff4d4d;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Utility & Typography --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .p-4 { padding: 1rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        
        code { font-family: 'Consolas', 'Monaco', monospace; background: #222; padding: 2px 5px; border-radius: 4px; color: var(--primary); }
        pre { background: #1a1a1a; padding: 10px; border-radius: 8px; overflow-x: auto; margin: 10px 0; border: 1px solid var(--border); }

        /* --- Components --- */
        .btn {
            background: var(--glass);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.85rem;
        }
        .btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary-dim); }
        .btn-secondary { border-color: var(--border); color: var(--text-main); }
        .btn-secondary:hover { background: #222; color: #fff; border-color: #555; box-shadow: none; }
        .btn-danger { border-color: var(--danger); color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }

        /* --- Layout --- */
        #app-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            height: calc(100vh - 40px); /* Minus footer */
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        /* --- Sidebar (Uploads) --- */
        aside {
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 2rem 1rem;
            text-align: center;
            transition: all 0.3s;
            background: var(--glass);
        }
        .upload-zone.dragover { border-color: var(--primary); background: var(--primary-dim); }
        
        .file-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; }
        .file-item {
            background: #1a1a1a;
            border: 1px solid var(--border);
            padding: 0.8rem;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }
        .file-icon { color: var(--danger); font-size: 1.2rem; }
        
        /* --- Main Chat Area --- */
        main {
            display: flex;
            flex-direction: column;
            background: radial-gradient(circle at top right, #1a1a2e 0%, var(--bg-dark) 40%);
            position: relative;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message {
            max-width: 80%;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            line-height: 1.6;
            font-size: 0.95rem;
            animation: slideIn 0.3s ease-out;
            position: relative;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-msg {
            align-self: flex-end;
            background: var(--glass);
            border: 1px solid var(--border);
            border-bottom-right-radius: 2px;
        }

        .ai-msg {
            align-self: flex-start;
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid var(--primary-dim);
            border-bottom-left-radius: 2px;
        }
        
        .ai-msg strong { color: var(--primary); }
        .citation { 
            display: inline-block; 
            font-size: 0.75rem; 
            background: #222; 
            padding: 2px 6px; 
            border-radius: 4px; 
            margin-left: 5px; 
            border: 1px solid #444; 
            cursor: help;
        }

        .input-area {
            padding: 1.5rem;
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 1rem;
        }

        textarea {
            flex: 1;
            background: #0a0a0a;
            border: 1px solid var(--border);
            color: white;
            padding: 10px;
            border-radius: 6px;
            resize: none;
            height: 50px;
        }
        textarea:focus { outline: none; border-color: var(--primary); }

        /* --- Modals & Overlays --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex; align-items: center; justify-content: center;
        }
        .modal {
            background: #151515;
            border: 1px solid var(--border);
            padding: 2rem;
            border-radius: 12px;
            width: 90%; max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .hero-section {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: var(--bg-dark);
            z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
        }
        .hero-title {
            font-size: 3rem;
            background: linear-gradient(to right, #fff, var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }

        /* Footer */
        footer {
            height: 40px;
            background: #050505;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            font-size: 0.8rem;
            color: var(--text-muted);
            z-index: 60;
        }
        footer a { color: var(--primary); text-decoration: none; }

        /* Loading Spinner */
        .spinner {
            width: 20px; height: 20px;
            border: 2px solid var(--bg-dark);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Results Table */
        .contradiction-table {
            width: 100%; border-collapse: collapse; margin-top: 10px;
            font-size: 0.9rem;
        }
        .contradiction-table th, .contradiction-table td {
            padding: 8px; border: 1px solid var(--border); text-align: left;
        }
        .contradiction-table th { background: #222; }
        .row-danger { background: rgba(255, 77, 77, 0.1); border-left: 3px solid var(--danger); }
        .row-warning { background: rgba(255, 184, 0, 0.1); border-left: 3px solid var(--warning); }

    </style>
</head>
<body>

    <!-- HERO SECTION -->
    <div id="hero" class="hero-section">
        <div style="font-size: 4rem; color: var(--primary); margin-bottom: 1rem;">
            <i class="fa-solid fa-file-shield"></i>
        </div>
        <h1 class="hero-title">AI Document Detective</h1>
        <p style="color: var(--text-muted); font-size: 1.2rem; margin-bottom: 2rem;">
            Powered by Vertex AI & Gemini 1.5
        </p>
        <div style="display:flex; gap:1rem;">
            <button class="btn" onclick="app.startApp()">Launch System</button>
            <button class="btn btn-secondary" onclick="app.toggleSettings()">Config API</button>
        </div>
    </div>

    <!-- MAIN APP LAYOUT -->
    <div id="app-container">
        <!-- Sidebar -->
        <aside>
            <div style="font-weight: bold; color: white; display: flex; align-items: center; gap: 8px;">
                <i class="fa-solid fa-folder-open" style="color:var(--primary)"></i> EVIDENCE LOCKER
            </div>
            
            <div id="drop-zone" class="upload-zone">
                <i class="fa-solid fa-cloud-arrow-up" style="font-size: 2rem; color: var(--text-muted); margin-bottom: 10px;"></i>
                <p style="font-size: 0.9rem;">Drag PDF contracts here</p>
                <input type="file" id="file-input" accept="application/pdf" multiple hidden>
                <button class="btn btn-secondary" style="margin-top: 10px; font-size: 0.7rem;" onclick="document.getElementById('file-input').click()">Browse Files</button>
            </div>

            <div id="processing-status" class="hidden" style="font-size: 0.8rem; color: var(--primary);">
                <span class="spinner"></span> Processing documents...
            </div>

            <div class="file-list" id="file-list-container">
                <!-- JS will populate files here -->
            </div>

            <div style="margin-top: auto;">
                <button class="btn w-full btn-danger" onclick="app.clearData()">
                    <i class="fa-solid fa-trash"></i> Clear All
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main>
            <div style="padding: 1rem; background: rgba(0,0,0,0.4); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; gap: 10px;">
                    <button class="btn" onclick="app.runContradictionScan()">
                        <i class="fa-solid fa-magnifying-glass-chart"></i> Auto-Scan Contradictions
                    </button>
                </div>
                <button class="btn btn-secondary" onclick="app.exportReport()">
                    <i class="fa-solid fa-download"></i> Export
                </button>
            </div>

            <div id="chat-container" class="chat-history">
                <!-- Welcome Message -->
                <div class="message ai-msg">
                    <strong><i class="fa-solid fa-robot"></i> System:</strong>
                    <br>Ready to analyze. Upload PDF contracts to the Evidence Locker.
                    <br><br>
                    Try asking:
                    <ul>
                        <li>"Summarize the payment terms."</li>
                        <li>"Are there any penalty clauses?"</li>
                        <li>"Find contradictions between the NDA and the Service Agreement."</li>
                    </ul>
                </div>
            </div>

            <div class="input-area">
                <textarea id="user-input" placeholder="Ask a question about the uploaded documents..." onkeydown="if(event.key === 'Enter' && !event.shiftKey){ event.preventDefault(); app.sendMessage(); }"></textarea>
                <button class="btn" onclick="app.sendMessage()">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </main>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal">
            <h2 style="margin-bottom: 1rem;">System Configuration</h2>
            <div class="flex flex-col gap-2">
                <label style="font-size: 0.9rem; color: var(--text-muted);">Gemini API Key</label>
                <input type="password" id="api-key-input" placeholder="Paste your Google AI Studio key here" 
                       style="background: #222; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 4px; width: 100%;">
                <p style="font-size: 0.75rem; color: #666;">
                    Key is stored locally in your browser. Get one at <a href="https://aistudio.google.com/" target="_blank" style="color:var(--primary)">Google AI Studio</a>.
                </p>
            </div>
            <div style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem;">
                <button class="btn btn-secondary" onclick="app.toggleSettings()">Close</button>
                <button class="btn" onclick="app.saveSettings()">Save Configuration</button>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer>
        <div>
            <i class="fa-solid fa-fire"></i> Deployed on <strong>Firebase Hosting</strong>
        </div>
        <div>
            Vertex AI Search & Conversation Architecture | <a href="#" onclick="app.toggleSettings()">Settings</a>
        </div>
    </footer>

    <script>
        // --- CONFIG & STATE ---
        // Configure PDF.js Worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const state = {
            documents: [], // { name: string, text: string }
            fullContext: "", // Combined text of all docs
            apiKey: localStorage.getItem('gemini_api_key') || "",
            history: []
        };

        // --- APP CONTROLLER ---
        const app = {
            init: () => {
                // Drag & Drop Listeners
                const dropZone = document.getElementById('drop-zone');
                const fileInput = document.getElementById('file-input');

                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, preventDefaults, false);
                });

                function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

                dropZone.addEventListener('dragover', () => dropZone.classList.add('dragover'));
                dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
                dropZone.addEventListener('drop', handleDrop);
                fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

                // Check API Key
                if(!state.apiKey) {
                    setTimeout(() => app.toggleSettings(), 1000);
                }
            },

            startApp: () => {
                document.getElementById('hero').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('app-container').style.opacity = '1';
            },

            toggleSettings: () => {
                const modal = document.getElementById('settings-modal');
                modal.classList.toggle('hidden');
                if(!modal.classList.contains('hidden')) {
                    document.getElementById('api-key-input').value = state.apiKey;
                }
            },

            saveSettings: () => {
                const key = document.getElementById('api-key-input').value.trim();
                if(key) {
                    state.apiKey = key;
                    localStorage.setItem('gemini_api_key', key);
                    alert('System Connected: API Key Saved.');
                    app.toggleSettings();
                } else {
                    alert('Please enter a valid API key.');
                }
            },

            clearData: () => {
                state.documents = [];
                state.fullContext = "";
                document.getElementById('file-list-container').innerHTML = '';
                document.getElementById('chat-container').innerHTML = '';
                utils.addMessage('system', 'Evidence locker cleared. Ready for new documents.');
            },

            // --- AI LOGIC ---
            sendMessage: async () => {
                const input = document.getElementById('user-input');
                const question = input.value.trim();
                if (!question) return;
                
                if (!state.apiKey) {
                    alert('Missing Authorization: Please configure your API Key in settings.');
                    app.toggleSettings();
                    return;
                }

                if (state.documents.length === 0) {
                    alert('No Evidence: Please upload a PDF contract first.');
                    return;
                }

                // Render User Message
                utils.addMessage('user', question);
                input.value = '';

                // Show loading
                const loadingId = utils.addLoading();

                try {
                    // Gemini Prompt Engineering
                    const prompt = `
                        Role: You are an expert Legal AI Assistant named "DocuDetective".
                        Context: The user has uploaded the following contract text: 
                        "${state.fullContext.substring(0, 30000)}" (truncated if too long).
                        
                        Task: Answer the user's question: "${question}".
                        
                        Constraints:
                        1. Only answer based on the provided text.
                        2. If the answer is not in the text, state that.
                        3. Cite specific clauses or section numbers if available.
                        4. Format output in Markdown.
                        5. Be professional, concise, and objective.
                    `;

                    const response = await aiService.callGemini(prompt);
                    utils.removeLoading(loadingId);
                    utils.addMessage('ai', response);

                } catch (error) {
                    utils.removeLoading(loadingId);
                    utils.addMessage('system', `Error: ${error.message}`);
                }
            },

            runContradictionScan: async () => {
                if (state.documents.length === 0) return alert("Upload documents first.");
                if (!state.apiKey) return app.toggleSettings();

                utils.addMessage('user', "Run auto-scan for contradictions.");
                const loadingId = utils.addLoading();

                try {
                    const prompt = `
                        Role: Legal Compliance Auditor.
                        Context: Provided contract text.
                        Task: Analyze the entire text for:
                        1. Internal contradictions (Clause A says X, Clause B says Not X).
                        2. Ambiguous payment terms.
                        3. Missing standard termination clauses.
                        
                        Output Format:
                        Create a Markdown table with columns: "Issue Type", "Description", "Severity (High/Medium)".
                        If no contradictions are found, clearly state "No contradictions detected."
                    `;
                    
                    const response = await aiService.callGemini(prompt);
                    utils.removeLoading(loadingId);
                    utils.addMessage('ai', response);
                } catch (e) {
                    utils.removeLoading(loadingId);
                    utils.addMessage('system', `Scan failed: ${e.message}`);
                }
            },
            
            exportReport: () => {
                const chatContent = document.getElementById('chat-container').innerText;
                const blob = new Blob([chatContent], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'AI_Analysis_Report.txt';
                a.click();
            }
        };

        // --- PDF PROCESSING ---
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
            document.getElementById('drop-zone').classList.remove('dragover');
        }

        async function handleFiles(files) {
            const status = document.getElementById('processing-status');
            status.classList.remove('hidden');

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type !== 'application/pdf') continue;

                try {
                    const text = await parsePDF(file);
                    
                    // Update State
                    state.documents.push({ name: file.name, text: text });
                    state.fullContext += `\n--- DOCUMENT: ${file.name} ---\n${text}\n`;

                    // Update UI
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'file-item';
                    fileDiv.innerHTML = `
                        <i class="fa-solid fa-file-pdf file-icon"></i>
                        <div style="overflow:hidden;">
                            <div style="font-weight:bold;">${file.name}</div>
                            <div style="font-size:0.7rem; color:#888;">${(file.size/1024).toFixed(1)} KB | processed</div>
                        </div>
                    `;
                    document.getElementById('file-list-container').appendChild(fileDiv);

                } catch (err) {
                    console.error(err);
                    alert(`Failed to parse ${file.name}`);
                }
            }
            status.classList.add('hidden');
        }

        async function parsePDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = "";

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += `[Page ${i}] ${pageText}\n`;
            }
            return fullText;
        }

        // --- AI SERVICE (GEMINI) ---
        const aiService = {
            callGemini: async (promptText) => {
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${state.apiKey}`;
                
                const payload = {
                    contents: [{
                        parts: [{ text: promptText }]
                    }]
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            }
        };

        // --- UI UTILS ---
        const utils = {
            addMessage: (role, text) => {
                const container = document.getElementById('chat-container');
                const div = document.createElement('div');
                div.className = `message ${role === 'user' ? 'user-msg' : 'ai-msg'}`;
                
                let icon = role === 'user' ? '<i class="fa-solid fa-user"></i>' : '<i class="fa-solid fa-robot"></i>';
                let header = role === 'user' ? 'You' : 'AI Detective';
                
                // Parse Markdown
                const parsedText = marked.parse(text);

                div.innerHTML = `
                    <strong>${icon} ${header}:</strong>
                    <div style="margin-top: 5px;">${parsedText}</div>
                `;
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
            },

            addLoading: () => {
                const container = document.getElementById('chat-container');
                const id = 'loading-' + Date.now();
                const div = document.createElement('div');
                div.id = id;
                div.className = 'message ai-msg';
                div.innerHTML = `<span class="spinner"></span> Analyzing document structure...`;
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
                return id;
            },

            removeLoading: (id) => {
                const el = document.getElementById(id);
                if (el) el.remove();
            }
        };

        // Init App
        app.init();

    </script>
</body>
</html>