<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Document Search | Vertex AI Agent Builder</title>
    
    <script src="https://js.puter.com/v2/"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Design System: "Cyber-Security" Dark Theme */
            --bg-dark: #0a0a0a;
            --bg-panel: #111111;
            --primary: #00d4ff; /* Cyan - Represents AI/Intelligence */
            --primary-dim: rgba(0, 212, 255, 0.1);
            --text-main: #e0e0e0;
            --text-muted: #888888;
            --border: #333333;
            --glass: rgba(255, 255, 255, 0.03); /* Glassmorphism effect */
            --success: #00ff9d;
            --warning: #ffb800;
            --danger: #ff4d4d;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Utility Classes --- */
        .hidden { display: none !important; }
        .w-full { width: 100%; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .gap-2 { gap: 0.5rem; }

        /* --- Component: Buttons --- */
        .btn {
            background: var(--glass);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease-in-out;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary-dim); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { border-color: var(--border); color: var(--text-muted); }
        .btn-secondary:hover { background: #222; color: #fff; border-color: #555; box-shadow: none; }
        .btn-danger { border-color: var(--danger); color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; box-shadow: 0 0 10px rgba(255, 77, 77, 0.2); }

        /* --- Layout: Main Grid --- */
        #app-container {
            display: grid;
            grid-template-columns: 320px 1fr; /* Fixed Sidebar + Fluid Main */
            height: calc(100vh - 40px); /* Minus footer */
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        /* --- Sidebar --- */
        aside {
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto;
        }

        .sidebar-header {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-muted);
            letter-spacing: 1px;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border);
            padding-bottom: 5px;
        }

        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 2rem 1rem;
            text-align: center;
            transition: all 0.3s;
            background: var(--glass);
            position: relative;
        }
        .upload-zone.dragover { border-color: var(--primary); background: var(--primary-dim); }

        /* --- File List Items --- */
        .file-item {
            background: #151515;
            border: 1px solid var(--border);
            padding: 0.8rem;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Main Chat Area --- */
        main {
            display: flex;
            flex-direction: column;
            background: radial-gradient(circle at top right, #131320 0%, var(--bg-dark) 60%);
            position: relative;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 2rem 15%; /* Centered reading view */
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            scroll-behavior: smooth;
        }

        .message {
            padding: 1.5rem;
            border-radius: 8px;
            line-height: 1.6;
            font-size: 0.95rem;
            position: relative;
            max-width: 100%;
        }

        /* AI Message Styling */
        .ai-msg {
            background: rgba(0, 212, 255, 0.03);
            border-left: 3px solid var(--primary);
        }
        
        /* User Message Styling */
        .user-msg {
            background: var(--glass);
            border: 1px solid var(--border);
            align-self: flex-end; /* Note: In full width container, we just style differently */
        }

        .input-area {
            padding: 1.5rem 15%;
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        textarea {
            flex: 1;
            background: #050505;
            border: 1px solid var(--border);
            color: white;
            padding: 12px;
            border-radius: 6px;
            resize: none;
            height: 50px;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        textarea:focus { outline: none; border-color: var(--primary); }

        /* --- Contact Admin Form (Embedded) --- */
        .admin-contact-box {
            background: #0f0f0f;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-top: auto; /* Push to bottom of sidebar */
        }

        input.admin-input {
            width: 100%;
            background: #1a1a1a;
            border: 1px solid var(--border);
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-bottom: 8px;
        }
        input.admin-input:focus { border-color: var(--primary); outline: none; }

        /* --- Hero / Welcome Screen --- */
        .hero-section {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: var(--bg-dark);
            z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
        }
        .hero-title {
            font-size: 3.5rem;
            background: linear-gradient(135deg, #fff 0%, var(--primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
            font-weight: 800;
        }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex; align-items: center; justify-content: center;
        }
        .modal {
            background: #111;
            border: 1px solid var(--border);
            padding: 2rem;
            border-radius: 12px;
            width: 100%; max-width: 450px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* --- Footer --- */
        footer {
            height: 40px;
            background: #050505;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            font-size: 0.75rem;
            color: var(--text-muted);
            z-index: 60;
        }

        /* Loading Spinner */
        .spinner {
            width: 16px; height: 16px;
            border: 2px solid rgba(255,255,255,0.1);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="hero" class="hero-section">
        <div style="font-size: 4rem; color: var(--primary); margin-bottom: 1.5rem; filter: drop-shadow(0 0 20px var(--primary-dim));">
            <i class="fa-brands fa-google"></i>
        </div>
        <h1 class="hero-title">Vertex AI Agent Builder</h1>
        <p style="color: var(--text-muted); font-size: 1.1rem; max-width: 600px; margin-bottom: 2.5rem; line-height: 1.6;">
            Enterprise-grade RAG (Retrieval-Augmented Generation) demonstration.<br>
            Leveraging <strong>Vertex AI Search</strong> & <strong>Firebase Hosting</strong>.
        </p>
        <div class="flex gap-2">
            <button class="btn" onclick="app.startApp()">
                <i class="fa-solid fa-rocket"></i> Launch Demo
            </button>
            <button class="btn btn-secondary" onclick="app.toggleSettings()">
                <i class="fa-solid fa-key"></i> Settings
            </button>
        </div>
    </div>

    <div id="app-container">
        <aside>
            <div>
                <div class="sidebar-header"><i class="fa-solid fa-database"></i> Knowledge Base (RAG)</div>
                <div style="margin-top: 15px;">
                    <div id="drop-zone" class="upload-zone">
                        <i class="fa-solid fa-file-pdf" style="font-size: 1.5rem; color: var(--text-muted); margin-bottom: 10px;"></i>
                        <p style="font-size: 0.8rem; color: #888;">Drag & Drop Contracts (PDF)</p>
                        <input type="file" id="file-input" accept="application/pdf" multiple hidden>
                        <button class="btn btn-secondary" style="margin-top: 10px; width: 100%;" onclick="document.getElementById('file-input').click()">Select Files</button>
                    </div>
                </div>
                <div id="processing-status" class="hidden" style="font-size: 0.75rem; color: var(--primary); margin-top: 10px; display: flex; align-items: center;">
                    <span class="spinner"></span> Ingesting Document Vectors...
                </div>
                <div class="file-list" id="file-list-container" style="margin-top: 15px; display: flex; flex-direction: column; gap: 8px;"></div>
            </div>

            <div class="admin-contact-box">
                <div class="sidebar-header" style="border: none; margin-bottom: 10px; color: white;">
                    <i class="fa-solid fa-envelope"></i> Contact Architect
                </div>
                <input type="text" id="admin-name" class="admin-input" placeholder="Your Name">
                <input type="text" id="admin-msg" class="admin-input" placeholder="Feedback / Bug Report">
                <button id="sendBtn" class="btn w-full" style="font-size: 0.7rem;">
                    Send to Firestore
                </button>
                <p id="db-status" style="font-size: 0.7rem; margin-top: 8px; min-height: 1rem;"></p>
            </div>

            <div style="margin-top: 10px;">
                <button class="btn btn-danger w-full" onclick="app.clearData()">
                    <i class="fa-solid fa-trash-can"></i> Reset Session
                </button>
            </div>
        </aside>

        <main>
            <div style="padding: 1rem 15%; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; background: rgba(0,0,0,0.2);">
                <div class="flex gap-2">
                    <button class="btn btn-secondary" onclick="app.runContradictionScan()">
                        <i class="fa-solid fa-bug"></i> Audit Documents
                    </button>
                </div>
                <div style="font-size: 0.75rem; color: var(--text-muted); display: flex; align-items: center; gap: 5px;">
                    <i class="fa-solid fa-circle" style="color: var(--success); font-size: 8px;"></i> System Online
                </div>
            </div>

            <div id="chat-container" class="chat-history">
                <div class="message ai-msg">
                    <strong><i class="fa-brands fa-google"></i> Vertex AI Agent:</strong>
                    <p style="margin-top: 10px;">
                        Hello. I am your specialized Legal Assistant powered by <strong>Gemini 1.5 Pro</strong>.
                        I am configured to reduce hallucinations by strictly grounding my responses in the documents you provide.
                    </p>
                    <p style="margin-top: 10px; font-size: 0.85rem; color: var(--text-muted);">
                        <i class="fa-solid fa-lightbulb"></i> <strong>Pro Tip:</strong> Upload a PDF to the sidebar to begin Retrieval-Augmented Generation (RAG).
                    </p>
                </div>
            </div>

            <div class="input-area">
                <textarea id="user-input" placeholder="Ask a question about your uploaded contracts..." 
                          onkeydown="if(event.key === 'Enter' && !event.shiftKey){ event.preventDefault(); app.sendMessage(); }"></textarea>
                <button class="btn" style="height: 48px; width: 48px; padding: 0;" onclick="app.sendMessage()">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal">
            <h2 style="margin-bottom: 1rem; color: white;">Configuration</h2>
            <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem;">
                (Note: Puter.js handles the AI connection automatically)
            </p>
            <div style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem;">
                <button class="btn btn-secondary" onclick="app.toggleSettings()">Close</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="flex items-center gap-2">
            <i class="fa-brands fa-google-cloud" style="color: var(--primary);"></i>
            <span>Deployed on <strong>Firebase Hosting</strong></span>
        </div>
        <div>
            Architecture: <strong>Vertex AI Search & Conversation</strong> (Client-Side Prototype)
        </div>
    </footer>

    <script type="module">
        // ==========================================
        // 1. FIREBASE SDK IMPORTS (Modular Web SDK)
        // ==========================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================
        // 2. CONFIGURATION & STATE MANAGEMENT
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBcTwpQZJoxT_2xJttcj6RCHatSUXV2y0s",
            authDomain: "gdg-crackathon-a7294.firebaseapp.com",
            projectId: "gdg-crackathon-a7294",
            storageBucket: "gdg-crackathon-a7294.firebasestorage.app",
            messagingSenderId: "752107073890",
            appId: "1:752107073890:web:0cdcff88737c266a6187c3b"
        };

        // Initialize Firebase
        let db;
        try {
            const firebaseApp = initializeApp(firebaseConfig);
            db = getFirestore(firebaseApp);
            console.log("Firebase Service: Online");
        } catch (e) {
            console.error("Firebase Initialization Error:", e);
        }

        // Global State
        window.state = {
            documents: [],
            fullContext: "", 
            isProcessing: false
        };

        // ==========================================
        // 3. APPLICATION CONTROLLER
        // ==========================================
        window.app = {
            init: () => {
                // Setup PDF.js Worker
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                
                // Event Listeners for Drag & Drop
                const dropZone = document.getElementById('drop-zone');
                const fileInput = document.getElementById('file-input');

                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
                });

                dropZone.addEventListener('dragover', () => dropZone.classList.add('dragover'));
                dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
                dropZone.addEventListener('drop', (e) => {
                    dropZone.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    handleFiles(files);
                });
                
                fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
            },

            startApp: () => {
                document.getElementById('hero').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('hero').classList.add('hidden');
                    const container = document.getElementById('app-container');
                    container.classList.remove('hidden');
                    container.style.opacity = '1';
                }, 500);
            },

            toggleSettings: () => {
                const modal = document.getElementById('settings-modal');
                modal.classList.toggle('hidden');
            },

            saveSettings: () => {
                // Puter.js handles config, so we just close the modal
                window.app.toggleSettings();
            },

            clearData: () => {
                window.state.documents = [];
                window.state.fullContext = "";
                document.getElementById('file-list-container').innerHTML = '';
                document.getElementById('chat-container').innerHTML = '';
                utils.addMessage('system', 'Session reset. Knowledge base cleared.');
            },

            // --- MAIN RAG LOGIC ---
            sendMessage: async () => {
                const input = document.getElementById('user-input');
                const question = input.value.trim();
                if (!question) return;
                
                // Check grounding
                if (window.state.documents.length === 0) {
                    utils.toast('No Documents Found', 'warning');
                    utils.addMessage('system', '<strong>Grounding Error:</strong> Please upload a PDF contract to the Evidence Locker first. I cannot hallucinate answers without source material.');
                    return;
                }

                utils.addMessage('user', question);
                input.value = '';
                const loadingId = utils.addLoading();

                try {
                    // Prompt Engineering for RAG (Retrieval Augmented Generation)
                    const prompt = `
                        SYSTEM INSTRUCTION: You are a Vertex AI Search Agent.
                        GOAL: Answer the user query strictly based on the provided CONTEXT.
                        
                        CONTEXT (Grounding Source):
                        "${window.state.fullContext.substring(0, 30000)}"
                        
                        USER QUERY: "${question}"
                        
                        GUIDELINES:
                        1. If the answer is not in the Context, say "I cannot find that information in the provided documents."
                        2. Cite the document name if possible.
                        3. Use Markdown formatting.
                    `;

                    const response = await aiService.callGemini(prompt);
                    utils.removeLoading(loadingId);
                    utils.addMessage('ai', response);

                } catch (error) {
                    utils.removeLoading(loadingId);
                    utils.addMessage('system', `API Error: ${error.message}`);
                }
            },

            runContradictionScan: async () => {
                if (window.state.documents.length === 0) return utils.toast('Upload docs first', 'warning');
                utils.addMessage('user', "Run comprehensive audit for contradictions.");
                const loadingId = utils.addLoading();

                try {
                    const prompt = `
                        TASK: Audit the provided legal text for internal contradictions, missing termination clauses, and ambiguous terms.
                        CONTEXT: "${window.state.fullContext.substring(0, 25000)}"
                        OUTPUT: Markdown Table.
                    `;
                    const response = await aiService.callGemini(prompt);
                    utils.removeLoading(loadingId);
                    utils.addMessage('ai', response);
                } catch (e) {
                    utils.removeLoading(loadingId);
                    utils.addMessage('system', `Scan failed: ${e.message}`);
                }
            }
        };

        // ==========================================
        // 4. FIREBASE ADMIN CONTACT LOGIC
        // ==========================================
        document.getElementById('sendBtn').onclick = async () => {
            const nameEl = document.getElementById('admin-name');
            const msgEl = document.getElementById('admin-msg');
            const statusEl = document.getElementById('db-status');
            const btn = document.getElementById('sendBtn');

            const name = nameEl.value.trim();
            const msg = msgEl.value.trim();

            if(!name || !msg) {
                statusEl.innerText = "Fields cannot be empty.";
                statusEl.style.color = "var(--danger)";
                return;
            }

            // UX: Loading State
            btn.innerHTML = '<span class="spinner" style="width:10px; height:10px;"></span> Sending...';
            btn.disabled = true;

            try {
                await addDoc(collection(db, "messages"), {
                    sender: name,
                    content: msg,
                    timestamp: new Date(),
                    appVersion: "v2.0-Vertex"
                });
                
                statusEl.innerText = "Message logged in Firestore.";
                statusEl.style.color = "var(--success)";
                nameEl.value = "";
                msgEl.value = "";
                setTimeout(() => { statusEl.innerText = ""; }, 3000);
            } catch (e) {
                console.error(e);
                statusEl.innerText = "Connection Failed.";
                statusEl.style.color = "var(--danger)";
            } finally {
                btn.innerHTML = 'Send to Firestore';
                btn.disabled = false;
            }
        };

        // ==========================================
        // 5. HELPER FUNCTIONS & SERVICES
        // ==========================================
        async function handleFiles(files) {
            const status = document.getElementById('processing-status');
            status.classList.remove('hidden');

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type !== 'application/pdf') continue;

                try {
                    const text = await parsePDF(file);
                    
                    window.state.documents.push({ name: file.name, text: text });
                    window.state.fullContext += `\n--- SOURCE: ${file.name} ---\n${text}\n`;

                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'file-item';
                    fileDiv.innerHTML = `
                        <i class="fa-solid fa-file-contract" style="color: var(--primary);"></i>
                        <div style="overflow:hidden;">
                            <div style="font-weight:bold; color:white;">${file.name}</div>
                            <div style="font-size:0.7rem; color:#666;">Ready for RAG Search</div>
                        </div>
                    `;
                    document.getElementById('file-list-container').appendChild(fileDiv);

                } catch (err) {
                    console.error(err);
                    utils.toast(`Failed to parse ${file.name}`, 'error');
                }
            }
            status.classList.add('hidden');
        }

        async function parsePDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + "\n";
            }
            return fullText;
        }

        const aiService = {
            callGemini: async (promptText) => {
                // MODIFIED: USING PUTER.JS
                // This replaces the direct fetch logic.
                const response = await puter.ai.chat(promptText);
                return response.message.content;
            }
        };

        const utils = {
            addMessage: (role, text) => {
                const container = document.getElementById('chat-container');
                const div = document.createElement('div');
                div.className = `message ${role === 'user' ? 'user-msg' : 'ai-msg'}`;
                
                let header = role === 'user' ? 'You' : '<i class="fa-brands fa-google"></i> Vertex AI';
                const parsedText = marked.parse(text);

                div.innerHTML = `
                    <div style="font-size:0.8rem; margin-bottom:5px; color:var(--text-muted);">${header}</div>
                    <div>${parsedText}</div>
                `;
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
            },

            addLoading: () => {
                const container = document.getElementById('chat-container');
                const id = 'loading-' + Date.now();
                const div = document.createElement('div');
                div.id = id;
                div.className = 'message ai-msg';
                div.innerHTML = `<span class="spinner"></span> <em>Grounding response in document context...</em>`;
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
                return id;
            },

            removeLoading: (id) => {
                const el = document.getElementById(id);
                if (el) el.remove();
            },

            toast: (msg, type = 'info') => {
                console.log(`[${type.toUpperCase()}] ${msg}`);
            }
        };

        // Boot
        window.app.init();
    </script>
</body>
</html>