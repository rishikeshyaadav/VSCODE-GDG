<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Document Search | Vertex AI Agent Builder</title>
    
    <script src="https://js.puter.com/v2/"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-dark: #0a0a0a;
            --bg-panel: #111111;
            --primary: #00d4ff; 
            --primary-dim: rgba(0, 212, 255, 0.1);
            --text-main: #e0e0e0;
            --text-muted: #888888;
            --border: #333333;
            --glass: rgba(255, 255, 255, 0.03);
            --success: #00ff9d;
            --warning: #ffb800;
            --danger: #ff4d4d;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh; /* Strict full height */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Prevent body scroll */
        }

        /* --- Utility Classes --- */
        .hidden { display: none !important; }
        .w-full { width: 100%; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .gap-2 { gap: 0.5rem; }

        /* --- Buttons --- */
        .btn {
            background: var(--glass);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease-in-out;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary-dim); }
        .btn-secondary { border-color: var(--border); color: var(--text-muted); }
        .btn-secondary:hover { background: #222; color: #fff; border-color: #555; }
        .btn-danger { border-color: var(--danger); color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }

        /* --- Layout: Grid --- */
        #app-container {
            display: grid;
            grid-template-columns: 320px 1fr; 
            height: calc(100vh - 40px); /* Exact height minus footer */
            opacity: 0;
            transition: opacity 0.5s ease;
            overflow: hidden; /* Important for inner scrolling */
        }

        /* --- Sidebar --- */
        aside {
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto; /* Scrollable sidebar */
            height: 100%;
        }

        .sidebar-header {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-muted);
            letter-spacing: 1px;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border);
            padding-bottom: 5px;
        }

        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 2rem 1rem;
            text-align: center;
            transition: all 0.3s;
            background: var(--glass);
        }
        .upload-zone.dragover { border-color: var(--primary); background: var(--primary-dim); }

        .file-item {
            background: #151515;
            border: 1px solid var(--border);
            padding: 0.8rem;
            border-radius: 6px;
            display: flex; align-items: center; gap: 10px;
            font-size: 0.85rem;
        }

        /* --- Main Chat Area --- */
        main {
            display: flex;
            flex-direction: column;
            background: radial-gradient(circle at top right, #131320 0%, var(--bg-dark) 60%);
            position: relative;
            overflow: hidden; /* FIXED: Ensures chat history scrolls properly */
            height: 100%;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto; /* Enable scrolling */
            padding: 2rem 15%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            scroll-behavior: smooth;
        }

        .message {
            padding: 1.5rem;
            border-radius: 8px;
            line-height: 1.6;
            font-size: 0.95rem;
            max-width: 100%;
        }

        .ai-msg { background: rgba(0, 212, 255, 0.03); border-left: 3px solid var(--primary); }
        .user-msg { background: var(--glass); border: 1px solid var(--border); align-self: flex-end; }

        .input-area {
            padding: 1.5rem 15%;
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            flex-shrink: 0; /* Prevents input area from shrinking */
        }

        textarea {
            flex: 1;
            background: #050505;
            border: 1px solid var(--border);
            color: white;
            padding: 12px;
            border-radius: 6px;
            resize: none;
            height: 50px;
            font-family: inherit;
        }
        textarea:focus { outline: none; border-color: var(--primary); }

        /* --- Contact Admin Form --- */
        .admin-contact-box {
            background: #0f0f0f;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-top: auto;
        }

        input.admin-input {
            width: 100%;
            background: #1a1a1a;
            border: 1px solid var(--border);
            color: white;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        /* --- Hero --- */
        .hero-section {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: var(--bg-dark);
            z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
        }
        .hero-title {
            font-size: 3.5rem;
            background: linear-gradient(135deg, #fff 0%, var(--primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
            font-weight: 800;
        }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex; align-items: center; justify-content: center;
        }
        .modal {
            background: #111;
            border: 1px solid var(--border);
            padding: 2rem;
            border-radius: 12px;
            width: 100%; max-width: 450px;
        }

        /* --- Footer --- */
        footer {
            height: 40px;
            background: #050505;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            font-size: 0.75rem;
            color: var(--text-muted);
            z-index: 60;
            flex-shrink: 0;
        }

        .spinner {
            width: 16px; height: 16px;
            border: 2px solid rgba(255,255,255,0.1);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="hero" class="hero-section">
        <div style="font-size: 4rem; color: var(--primary); margin-bottom: 1.5rem; filter: drop-shadow(0 0 20px var(--primary-dim));">
            <i class="fa-brands fa-google"></i>
        </div>
        <h1 class="hero-title">Vertex AI Agent Builder</h1>
        <p style="color: var(--text-muted); font-size: 1.1rem; max-width: 600px; margin-bottom: 2.5rem; line-height: 1.6;">
            Enterprise-grade RAG (Retrieval-Augmented Generation) demonstration.<br>
            Leveraging <strong>Vertex AI Search</strong> & <strong>Firebase Hosting</strong>.
        </p>
        <div class="flex gap-2">
            <button class="btn" onclick="app.startApp()">
                <i class="fa-solid fa-rocket"></i> Launch Demo
            </button>
            <button class="btn btn-secondary" onclick="app.toggleSettings()">
                <i class="fa-solid fa-key"></i> Settings
            </button>
        </div>
    </div>

    <div id="app-container">
        <aside>
            <div>
                <div class="sidebar-header"><i class="fa-solid fa-database"></i> Knowledge Base (RAG)</div>
                <div style="margin-top: 15px;">
                    <div id="drop-zone" class="upload-zone">
                        <i class="fa-solid fa-file-pdf" style="font-size: 1.5rem; color: var(--text-muted); margin-bottom: 10px;"></i>
                        <p style="font-size: 0.8rem; color: #888;">Drag & Drop Contracts (PDF)</p>
                        <input type="file" id="file-input" accept="application/pdf" multiple hidden>
                        <button class="btn btn-secondary" style="margin-top: 10px; width: 100%;" onclick="document.getElementById('file-input').click()">Select Files</button>
                    </div>
                </div>
                <div id="processing-status" class="hidden" style="font-size: 0.75rem; color: var(--primary); margin-top: 10px; display: flex; align-items: center;">
                    <span class="spinner"></span> Ingesting Document Vectors...
                </div>
                <div class="file-list" id="file-list-container" style="margin-top: 15px; display: flex; flex-direction: column; gap: 8px;"></div>
            </div>

            <div class="admin-contact-box">
                <div class="sidebar-header" style="border: none; margin-bottom: 10px; color: white;">
                    <i class="fa-solid fa-envelope"></i> Contact Architect
                </div>
                <input type="text" id="admin-name" class="admin-input" placeholder="Your Name">
                <input type="text" id="admin-msg" class="admin-input" placeholder="Feedback / Bug Report">
                <button id="sendBtn" class="btn w-full" style="font-size: 0.7rem;">
                    Send to Firestore
                </button>
                <p id="db-status" style="font-size: 0.7rem; margin-top: 8px; min-height: 1rem;"></p>
            </div>

            <div style="margin-top: 10px;">
                <button class="btn btn-danger w-full" onclick="app.clearData()">
                    <i class="fa-solid fa-trash-can"></i> Reset Session
                </button>
            </div>
        </aside>

        <main>
            <div style="padding: 1rem 15%; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; background: rgba(0,0,0,0.2); flex-shrink: 0;">
                <div class="flex gap-2">
                    <button class="btn btn-secondary" onclick="app.runContradictionScan()">
                        <i class="fa-solid fa-bug"></i> Audit Documents
                    </button>
                </div>
                <div style="font-size: 0.75rem; color: var(--text-muted); display: flex; align-items: center; gap: 5px;">
                    <i class="fa-solid fa-circle" style="color: var(--success); font-size: 8px;"></i> System Online
                </div>
            </div>

            <div id="chat-container" class="chat-history">
                <div class="message ai-msg">
                    <strong><i class="fa-brands fa-google"></i> Vertex AI Agent:</strong>
                    <p style="margin-top: 10px;">
                        Hello. I am your specialized Legal Assistant powered by <strong>Gemini 1.5 Pro</strong>.
                    </p>
                    <p style="margin-top: 10px; font-size: 0.85rem; color: var(--text-muted);">
                        <i class="fa-solid fa-lightbulb"></i> <strong>Pro Tip:</strong> Upload a PDF to the sidebar to begin Retrieval-Augmented Generation (RAG).
                    </p>
                </div>
            </div>

            <div class="input-area">
                <textarea id="user-input" placeholder="Ask a question about your uploaded contracts..." 
                          onkeydown="if(event.key === 'Enter' && !event.shiftKey){ event.preventDefault(); app.sendMessage(); }"></textarea>
                <button class="btn" style="height: 48px; width: 48px; padding: 0;" onclick="app.sendMessage()">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal">
            <h2 style="margin-bottom: 1rem; color: white;">Configuration</h2>
            <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem;">
                (Note: Puter.js handles the AI connection automatically)
            </p>
            <div style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem;">
                <button class="btn btn-secondary" onclick="app.toggleSettings()">Close</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="flex items-center gap-2">
            <i class="fa-brands fa-google-cloud" style="color: var(--primary);"></i>
            <span>Deployed on <strong>Firebase Hosting</strong></span>
        </div>
        <div>
            Architecture: <strong>Vertex AI Search & Conversation</strong>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBcTwpQZJoxT_2xJttcj6RCHatSUXV2y0s",
            authDomain: "gdg-crackathon-a7294.firebaseapp.com",
            projectId: "gdg-crackathon-a7294",
            storageBucket: "gdg-crackathon-a7294.firebasestorage.app",
            messagingSenderId: "752107073890",
            appId: "1:752107073890:web:0cdcff88737c266a6187c3b"
        };

        let db;
        try {
            const firebaseApp = initializeApp(firebaseConfig);
            db = getFirestore(firebaseApp);
        } catch (e) { console.error(e); }

        window.state = { documents: [], fullContext: "" };

        window.app = {
            init: () => {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                const dropZone = document.getElementById('drop-zone');
                const fileInput = document.getElementById('file-input');

                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
                });

                dropZone.addEventListener('dragover', () => dropZone.classList.add('dragover'));
                dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
                dropZone.addEventListener('drop', (e) => {
                    dropZone.classList.remove('dragover');
                    handleFiles(e.dataTransfer.files);
                });
                fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
            },

            startApp: () => {
                document.getElementById('hero').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('hero').classList.add('hidden');
                    const container = document.getElementById('app-container');
                    container.classList.remove('hidden');
                    container.style.opacity = '1';
                }, 500);
            },

            toggleSettings: () => {
                document.getElementById('settings-modal').classList.toggle('hidden');
            },

            saveSettings: () => {
                window.app.toggleSettings();
            },

            clearData: () => {
                window.state.documents = [];
                window.state.fullContext = "";
                document.getElementById('file-list-container').innerHTML = '';
                document.getElementById('chat-container').innerHTML = '';
            },

            sendMessage: async () => {
                const input = document.getElementById('user-input');
                const question = input.value.trim();
                if (!question) return;

                if (window.state.documents.length === 0) {
                    utils.addMessage('system', 'Please upload a PDF first.');
                    return;
                }

                utils.addMessage('user', question);
                input.value = '';
                const loadingId = utils.addLoading();

                try {
                    const prompt = `
                        CONTEXT: "${window.state.fullContext.substring(0, 30000)}"
                        QUERY: "${question}"
                        Answer strictly based on context.
                    `;
                    const response = await aiService.callGemini(prompt);
                    utils.removeLoading(loadingId);
                    utils.addMessage('ai', response);
                } catch (error) {
                    utils.removeLoading(loadingId);
                    utils.addMessage('system', `Error: ${error.message}`);
                }
            },

            runContradictionScan: async () => {
                if (window.state.documents.length === 0) return;
                utils.addMessage('user', "Run audit.");
                const loadingId = utils.addLoading();
                try {
                    const prompt = `Audit for contradictions:\n"${window.state.fullContext.substring(0, 25000)}"`;
                    const response = await aiService.callGemini(prompt);
                    utils.removeLoading(loadingId);
                    utils.addMessage('ai', response);
                } catch (e) {
                    utils.removeLoading(loadingId);
                    utils.addMessage('system', `Error: ${e.message}`);
                }
            }
        };

        document.getElementById('sendBtn').onclick = async () => {
            const nameEl = document.getElementById('admin-name');
            const msgEl = document.getElementById('admin-msg');
            const statusEl = document.getElementById('db-status');
            
            if(!nameEl.value || !msgEl.value) {
                statusEl.innerText = "Empty fields."; return;
            }

            statusEl.innerText = "Sending...";
            try {
                await addDoc(collection(db, "messages"), {
                    sender: nameEl.value,
                    content: msgEl.value,
                    timestamp: new Date()
                });
                statusEl.innerText = "Saved to Firestore.";
                statusEl.style.color = "var(--success)";
                nameEl.value = ""; msgEl.value = "";
            } catch (e) {
                statusEl.innerText = "Error.";
            }
        };

        async function handleFiles(files) {
            document.getElementById('processing-status').classList.remove('hidden');
            for (let i = 0; i < files.length; i++) {
                if (files[i].type !== 'application/pdf') continue;
                try {
                    const text = await parsePDF(files[i]);
                    window.state.documents.push({ name: files[i].name, text: text });
                    window.state.fullContext += `\n--- ${files[i].name} ---\n${text}\n`;
                    
                    const div = document.createElement('div');
                    div.className = 'file-item';
                    div.innerHTML = `<i class="fa-solid fa-file-contract" style="color:var(--primary)"></i> <div>${files[i].name}</div>`;
                    document.getElementById('file-list-container').appendChild(div);
                } catch (e) { console.error(e); }
            }
            document.getElementById('processing-status').classList.add('hidden');
        }

        async function parsePDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join(' ') + "\n";
            }
            return fullText;
        }

        const aiService = {
            callGemini: async (promptText) => {
                // Using Puter.js
                const response = await puter.ai.chat(promptText);
                return response.message.content;
            }
        };

        const utils = {
            addMessage: (role, text) => {
                const container = document.getElementById('chat-container');
                const div = document.createElement('div');
                div.className = `message ${role === 'user' ? 'user-msg' : 'ai-msg'}`;
                div.innerHTML = `<strong>${role === 'user' ? 'You' : 'Vertex AI'}</strong>: ${marked.parse(text)}`;
                container.appendChild(div);
                // Scroll to bottom
                requestAnimationFrame(() => {
                    container.scrollTop = container.scrollHeight;
                });
            },
            addLoading: () => {
                const container = document.getElementById('chat-container');
                const id = 'l-' + Date.now();
                const div = document.createElement('div');
                div.id = id;
                div.className = 'message ai-msg';
                div.innerHTML = `<span class="spinner"></span> Thinking...`;
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
                return id;
            },
            removeLoading: (id) => {
                const el = document.getElementById(id);
                if(el) el.remove();
            }
        };

        window.app.init();
    </script>
</body>
</html>