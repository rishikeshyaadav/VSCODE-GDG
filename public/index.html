<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gemini DocuSearch | Google AI</title>
    
    <script src="https://js.puter.com/v2/"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-dark: #0a0a0a;
            --bg-panel: #111111;
            --primary: #4da6ff; 
            --primary-dim: rgba(77, 166, 255, 0.1);
            --text-main: #e0e0e0;
            --text-muted: #888888;
            --border: #333333;
            --glass: rgba(255, 255, 255, 0.03);
            --success: #00ff9d;
            --warning: #ffb800;
            --danger: #ff4d4d;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Utility --- */
        .hidden { display: none !important; }
        .w-full { width: 100%; }
        .flex { display: flex; }
        .gap-2 { gap: 0.5rem; }

        /* --- Buttons --- */
        .btn {
            background: var(--glass);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-secondary { border-color: var(--border); color: var(--text-muted); }
        .btn-danger { border-color: var(--danger); color: var(--danger); }

        /* --- Layout --- */
        #app-container {
            display: grid;
            grid-template-columns: 320px 1fr; 
            height: calc(100vh - 40px);
            opacity: 0;
            transition: opacity 0.5s ease;
            overflow: hidden;
            position: relative;
        }

        /* --- Sidebar --- */
        aside {
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto;
            height: 100%;
            z-index: 100;
        }

        /* --- User Profile Section --- */
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 10px;
        }
        .user-avatar {
            width: 32px; height: 32px; border-radius: 50%; background: var(--primary);
            display: flex; align-items: center; justify-content: center; font-weight: bold; color: black;
        }
        .user-info { font-size: 0.8rem; overflow: hidden; }
        .user-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-status { font-size: 0.7rem; color: var(--success); }

        /* --- Main Chat Area --- */
        main {
            display: flex;
            flex-direction: column;
            background: radial-gradient(circle at top right, #1a1f2e 0%, var(--bg-dark) 60%);
            position: relative;
            overflow: hidden;
            height: 100%;
            width: 100%;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 2rem 15%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            scroll-behavior: smooth;
        }

        .message {
            padding: 1.5rem;
            border-radius: 8px;
            line-height: 1.6;
            font-size: 0.95rem;
            max-width: 100%;
        }
        .ai-msg { background: rgba(77, 166, 255, 0.05); border-left: 3px solid var(--primary); }
        .user-msg { background: var(--glass); border: 1px solid var(--border); align-self: flex-end; }

        .suggestions-wrapper {
            padding: 0 15% 1rem 15%;
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .chips-container { display: flex; gap: 10px; }
        
        .chip {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            cursor: pointer;
            display: inline-flex; align-items: center; gap: 6px;
            flex-shrink: 0;
        }

        .input-area {
            padding: 0 15% 1.5rem 15%;
            background: var(--bg-panel);
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            flex-shrink: 0;
        }

        textarea {
            flex: 1;
            background: #050505;
            border: 1px solid var(--border);
            color: white;
            padding: 12px;
            border-radius: 6px;
            resize: none;
            height: 50px;
            font-family: inherit;
        }
        textarea:focus { outline: none; border-color: var(--primary); }

        .mobile-header-btn { display: none; }
        .mobile-close-btn { display: none; }
        .sidebar-backdrop { display: none; }

        @media (max-width: 768px) {
            #app-container { display: block; position: relative; }
            aside { position: fixed; top: 0; left: -100%; width: 85%; height: 100%; transition: left 0.3s ease; box-shadow: 10px 0 50px rgba(0,0,0,0.5); border-right: 1px solid var(--primary-dim); }
            aside.open { left: 0; }
            .mobile-header-btn { display: flex; padding: 8px 12px; background: var(--glass); border: 1px solid var(--border); border-radius: 4px; color: var(--text-main); cursor: pointer; }
            .mobile-close-btn { display: block; text-align: right; margin-bottom: 10px; }
            .sidebar-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 90; backdrop-filter: blur(2px); }
            .sidebar-backdrop.active { display: block; }
            .chat-history { padding: 1rem 1rem; }
            .input-area { padding: 0 1rem 1rem 1rem; }
            .suggestions-wrapper { padding: 0 1rem 1rem 1rem; }
            .hero-title { font-size: 2.2rem; }
            #hero p { padding: 0 20px; font-size: 1rem; }
        }

        .admin-contact-box { background: #0f0f0f; border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-top: auto; }
        input.admin-input { width: 100%; background: #1a1a1a; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 4px; margin-bottom: 8px; }

        footer { height: 40px; background: #050505; border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: center; padding: 0 10px; font-size: 0.65rem; color: var(--text-muted); z-index: 60; }
        .upload-zone { border: 2px dashed var(--border); border-radius: 8px; padding: 2rem 1rem; text-align: center; background: var(--glass); }
        .file-item { background: #151515; border: 1px solid var(--border); padding: 0.8rem; border-radius: 6px; display: flex; align-items: center; gap: 10px; font-size: 0.85rem; }
        
        .spinner { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.1); border-top: 2px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .gemini-sparkle { background: linear-gradient(135deg, #4da6ff 0%, #9b72cb 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body>

    <div id="hero" class="hero-section" style="position: absolute; top:0; left:0; width:100%; height:100%; background: var(--bg-dark); z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">
            <i class="fa-solid fa-wand-magic-sparkles gemini-sparkle"></i>
        </div>
        <h1 class="hero-title" style="margin-bottom: 1rem; font-weight: 800;">
            <span class="gemini-sparkle">Google Gemini</span> Agent
        </h1>
        <p style="color: var(--text-muted); margin-bottom: 2rem;">
            Intelligent Document Search & Analysis
        </p>
        <button class="btn" onclick="app.startApp()" style="padding: 1rem 2rem;">
            <i class="fa-solid fa-rocket"></i> Launch Gemini
        </button>
    </div>

    <div id="mobile-backdrop" class="sidebar-backdrop" onclick="app.toggleSidebar()"></div>

    <div id="app-container">
        <aside id="app-sidebar">
            <div class="mobile-close-btn">
                <button class="btn btn-secondary" style="border:none;" onclick="app.toggleSidebar()"><i class="fa-solid fa-xmark"></i> Close</button>
            </div>

            <div id="auth-section">
                <button id="loginBtn" class="btn w-full" style="margin-bottom: 15px; border-color: var(--text-muted); color: white;">
                    <i class="fa-brands fa-google"></i> Sign in with Google
                </button>
                <div id="user-display" class="user-profile hidden">
                    <img id="user-img" src="" class="user-avatar" alt="U">
                    <div class="user-info">
                        <div id="user-name" class="user-name">User</div>
                        <div class="user-status">● Online</div>
                    </div>
                    <button onclick="app.signOut()" style="background:none; border:none; color:var(--text-muted); cursor:pointer; margin-left:auto;"><i class="fa-solid fa-right-from-bracket"></i></button>
                </div>
            </div>

            <div>
                <div style="font-size: 0.8rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 10px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">
                    Knowledge Base
                </div>
                <div style="margin-top: 15px;">
                    <div id="drop-zone" class="upload-zone">
                        <i class="fa-solid fa-file-pdf" style="font-size: 1.5rem; color: var(--text-muted); margin-bottom: 10px;"></i>
                        <p style="font-size: 0.8rem; color: #888;">Tap to Upload PDF</p>
                        <input type="file" id="file-input" accept="application/pdf" multiple hidden>
                        <button class="btn btn-secondary" style="margin-top: 10px; width: 100%;" onclick="document.getElementById('file-input').click()">Select Files</button>
                    </div>
                </div>
                <div id="processing-status" class="hidden" style="font-size: 0.75rem; color: var(--primary); margin-top: 10px; display: flex; align-items: center;">
                    <span class="spinner"></span> Uploading & Reading...
                </div>
                <div class="file-list" id="file-list-container" style="margin-top: 15px; display: flex; flex-direction: column; gap: 8px;"></div>
            </div>

            <div class="admin-contact-box">
                <div style="font-size: 0.8rem; font-weight: 700; color: white; margin-bottom: 10px;">
                    <i class="fa-solid fa-envelope"></i> Contact Admin
                </div>
                <input type="text" id="admin-name" class="admin-input" placeholder="Your Name">
                <input type="text" id="admin-msg" class="admin-input" placeholder="Message">
                <button id="sendBtn" class="btn w-full" style="font-size: 0.7rem;">Send to Firestore</button>
                <p id="db-status" style="font-size: 0.7rem; margin-top: 8px; min-height: 1rem;"></p>
            </div>

            <div style="margin-top: 10px;">
                <button class="btn btn-danger w-full" onclick="app.clearData()">Reset</button>
            </div>
        </aside>

        <main>
            <div style="padding: 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); flex-shrink: 0;">
                <div class="flex gap-2 align-items-center">
                    <div class="mobile-header-btn" onclick="app.toggleSidebar()">
                        <i class="fa-solid fa-bars"></i>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="app.runContradictionScan()">
                        <i class="fa-solid fa-bug"></i> <span style="display:none; @media(min-width:768px){display:inline;}">Audit</span>
                    </button>
                </div>
                <div style="font-size: 0.75rem; color: var(--text-muted); display: flex; align-items: center; gap: 5px;">
                    <i class="fa-solid fa-circle" style="color: var(--success); font-size: 8px;"></i> Online
                </div>
            </div>

            <div id="chat-container" class="chat-history">
                <div class="message ai-msg">
                    <strong><i class="fa-solid fa-wand-magic-sparkles" style="color: #4da6ff;"></i> Gemini:</strong>
                    <p style="margin-top: 5px;">Hello! I'm ready. Sign in to save your session.</p>
                </div>
            </div>

            <div class="suggestions-wrapper">
                <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 8px;">QUICK ACTIONS:</div>
                <div class="chips-container">
                    <div class="chip" onclick="app.sendMessage('Identify the top 3 biggest risks.')"><i class="fa-solid fa-triangle-exclamation"></i> Risks</div>
                    <div class="chip" onclick="app.sendMessage('List termination clauses.')"><i class="fa-solid fa-hand"></i> Termination</div>
                    <div class="chip" onclick="app.sendMessage('Summarize payment terms.')"><i class="fa-solid fa-money-bill"></i> Payments</div>
                </div>
            </div>

            <div class="input-area">
                <textarea id="user-input" placeholder="Ask Gemini..." 
                          onkeydown="if(event.key === 'Enter' && !event.shiftKey){ event.preventDefault(); app.sendMessage(); }"></textarea>
                <button class="btn" style="height: 48px; width: 48px; padding: 0;" onclick="app.sendMessage()">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </main>
    </div>

    <footer>
        <div class="flex items-center gap-2">
            <i class="fa-brands fa-google" style="color: var(--primary);"></i>
            <span>Firebase</span>
        </div>
        <div>Gemini Mobile (Puter Engine)</div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBcTwpQZJoxT_2xJttcj6RCHatSUXV2y0s",
            authDomain: "gdg-crackathon-a7294.firebaseapp.com",
            projectId: "gdg-crackathon-a7294",
            storageBucket: "gdg-crackathon-a7294.firebasestorage.app",
            messagingSenderId: "752107073890",
            appId: "1:752107073890:web:0cdcff88737c266a6187c3b"
        };

        let db, storage, auth;
        try {
            const firebaseApp = initializeApp(firebaseConfig);
            db = getFirestore(firebaseApp);
            storage = getStorage(firebaseApp);
            auth = getAuth(firebaseApp);
        } catch (e) { 
            alert("Firebase Init Error: " + e.message);
        }

        window.state = { documents: [], fullContext: "", user: null };

        window.app = {
            init: () => {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                const dropZone = document.getElementById('drop-zone');
                const fileInput = document.getElementById('file-input');

                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
                });

                dropZone.addEventListener('dragover', () => dropZone.classList.add('dragover'));
                dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
                dropZone.addEventListener('drop', (e) => {
                    dropZone.classList.remove('dragover');
                    handleFiles(e.dataTransfer.files);
                });
                fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

                // Auth Logic
                if(auth) {
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            window.state.user = user;
                            document.getElementById('loginBtn').classList.add('hidden');
                            document.getElementById('user-display').classList.remove('hidden');
                            document.getElementById('user-name').textContent = user.displayName;
                            document.getElementById('user-img').src = user.photoURL || '';
                            document.getElementById('admin-name').value = user.displayName;
                        } else {
                            window.state.user = null;
                            document.getElementById('loginBtn').classList.remove('hidden');
                            document.getElementById('user-display').classList.add('hidden');
                        }
                    });
                }
            },

            startApp: () => {
                document.getElementById('hero').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('hero').classList.add('hidden');
                    const container = document.getElementById('app-container');
                    container.classList.remove('hidden');
                    container.style.opacity = '1';
                }, 500);
            },

            toggleSidebar: () => {
                const sidebar = document.getElementById('app-sidebar');
                const backdrop = document.getElementById('mobile-backdrop');
                sidebar.classList.toggle('open');
                backdrop.classList.toggle('active');
            },

            signOut: () => {
                if(auth) signOut(auth).then(() => utils.addMessage('system', 'Signed out successfully.'));
            },

            clearData: () => {
                window.state.documents = [];
                window.state.fullContext = "";
                document.getElementById('file-list-container').innerHTML = '';
                document.getElementById('chat-container').innerHTML = '';
            },

            sendMessage: async (manualText) => {
                const input = document.getElementById('user-input');
                const question = manualText || input.value.trim();
                
                if (!question) return;

                if (window.state.documents.length === 0) {
                    utils.addMessage('system', 'Please upload a PDF first (Check Menu).');
                    return;
                }

                utils.addMessage('user', question);
                input.value = '';
                const loadingId = utils.addLoading();

                try {
                    const prompt = `
                        You are an expert document analyst. Use the provided Context below to answer the Query.
                        If the answer is not in the context, state that clearly.
                        CONTEXT: "${window.state.fullContext.substring(0, 30000)}"
                        QUERY: "${question}"
                    `;
                    const response = await aiService.callPuter(prompt);
                    utils.removeLoading(loadingId);
                    utils.addMessage('ai', response);
                } catch (error) {
                    utils.removeLoading(loadingId);
                    utils.addMessage('system', `Error: ${error.message}`);
                }
            },

            runContradictionScan: async () => {
                if (window.state.documents.length === 0) return;
                utils.addMessage('user', "Running Audit...");
                const loadingId = utils.addLoading();
                try {
                    const prompt = `Audit for contradictions:\n"${window.state.fullContext.substring(0, 25000)}"`;
                    const response = await aiService.callPuter(prompt);
                    utils.removeLoading(loadingId);
                    utils.addMessage('ai', response);
                } catch (e) {
                    utils.removeLoading(loadingId);
                    utils.addMessage('system', `Error: ${e.message}`);
                }
            }
        };

        // --- UPDATED LOGIN LOGIC WITH ERROR ALERT ---
        document.getElementById('loginBtn').onclick = () => {
            if(auth) {
                const provider = new GoogleAuthProvider();
                signInWithPopup(auth, provider).catch(e => {
                    console.error(e);
                    // Alert the user so they can see the error code
                    alert("Login Error: " + e.message);
                });
            } else {
                alert("Firebase Auth not initialized. Check console for errors.");
            }
        };

        document.getElementById('sendBtn').onclick = async () => {
            const nameEl = document.getElementById('admin-name');
            const msgEl = document.getElementById('admin-msg');
            const statusEl = document.getElementById('db-status');
            
            if(!nameEl.value || !msgEl.value) {
                statusEl.innerText = "Empty fields."; return;
            }

            statusEl.innerText = "Sending...";
            try {
                const uid = window.state.user ? window.state.user.uid : 'anon';
                await addDoc(collection(db, "messages"), {
                    sender: nameEl.value,
                    content: msgEl.value,
                    uid: uid,
                    timestamp: new Date()
                });
                statusEl.innerText = "Sent.";
                statusEl.style.color = "var(--success)";
                msgEl.value = "";
            } catch (e) {
                statusEl.innerText = "Error: " + e.message;
            }
        };

        async function handleFiles(files) {
            document.getElementById('processing-status').classList.remove('hidden');
            const fileArray = Array.from(files);

            await Promise.all(fileArray.map(async (file) => {
                if (file.type !== 'application/pdf') return;

                try {
                    if (storage) {
                        const folder = window.state.user ? `users/${window.state.user.uid}/` : 'public/';
                        const storageRef = ref(storage, folder + file.name);
                        await uploadBytes(storageRef, file);
                        console.log(`Uploaded ${file.name}`);
                    }

                    const text = await parsePDF(file);
                    
                    window.state.documents.push({ name: file.name, text: text });
                    window.state.fullContext += `\n--- ${file.name} ---\n${text}\n`;
                    
                    const div = document.createElement('div');
                    div.className = 'file-item';
                    div.innerHTML = `<i class="fa-solid fa-file-contract" style="color:var(--primary)"></i> <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:180px;">${file.name}</div> <i class="fa-solid fa-cloud-arrow-up" style="color:var(--success); font-size:0.7rem;"></i>`;
                    document.getElementById('file-list-container').appendChild(div);

                    if (text.trim().length < 50) {
                        utils.addMessage('system', `⚠️ Warning: "${file.name}" appears to be a scanned image or empty. I might not be able to read it.`);
                    }

                } catch (e) { 
                    console.error("File Error:", e);
                    utils.addMessage('system', `Error reading ${file.name}: ${e.message}`);
                }
            }));

            document.getElementById('processing-status').classList.add('hidden');
        }

        async function parsePDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullText += textContent.items.map(item => item.str).join(' ') + "\n";
                }
                return fullText;
            } catch (e) {
                return "";
            }
        }

        const aiService = {
            callPuter: async (promptText) => {
                const response = await puter.ai.chat(promptText);
                return response.message.content;
            }
        };

        const utils = {
            addMessage: (role, text) => {
                const container = document.getElementById('chat-container');
                const div = document.createElement('div');
                div.className = `message ${role === 'user' ? 'user-msg' : 'ai-msg'}`;
                if (role === 'system') {
                    div.style.background = 'rgba(255, 184, 0, 0.1)';
                    div.style.borderLeft = '3px solid var(--warning)';
                    div.innerHTML = `<strong><i class="fa-solid fa-circle-info"></i> System:</strong> ${text}`;
                } else {
                    div.innerHTML = `<strong>${role === 'user' ? 'You' : 'Gemini'}</strong>: ${marked.parse(text)}`;
                }
                container.appendChild(div);
                requestAnimationFrame(() => { container.scrollTop = container.scrollHeight; });
            },
            addLoading: () => {
                const container = document.getElementById('chat-container');
                const id = 'l-' + Date.now();
                const div = document.createElement('div');
                div.id = id;
                div.className = 'message ai-msg';
                div.innerHTML = `<span class="spinner"></span> Thinking...`;
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
                return id;
            },
            removeLoading: (id) => {
                const el = document.getElementById(id);
                if(el) el.remove();
            }
        };

        window.app.init();
    </script>
</body>
</html>